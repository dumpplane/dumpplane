= NGINX Dump Plane
:toc: manual

image:ext/dumpplane-logo.png[Dumpplane logo]

== What's dumpplane?

The `dumpplane` is a tool work with link:https://github.com/nginxinc/crossplane[crossplane] to model and dump nginx configuration to Real Time Data Store(MongoDB, ElasticSearch, BigTable), which enables Ops Manage and Govern NGINX with a Modern No-SQL Data Analysis/Modern Observability/Modern AIOps Way.

image:ext/dumpplane-pipeline.png[]

The `nginx -T` output should same to a file and copy to a directory, which used as input of `dumpplane` tool, then the `dumpplane` and `crossplane` will transfer `nginx -T` output to Real Time Data Store finally.

[source, bash]
.*Install*
----
pip install dumpplane-0.0.1-py3-none-any.whl 
----

[source, bash]
.*Usage*
----
% dumpplane -h  
usage: dumpplane <command> [options]

various operations for nginx config files

optional arguments:
  -h, --help         show this help message and exit
  -V, --version      show program's version number and exit

commands:
  split              split a nginx dump(nginx -T) .conf to raw files
  dump               dump crossplane parsed .json to data storage
  help               show help for commands

----


== How to run?

In order to run `dumpplane`, you need make sure all link:#prerequisites-for-run-dumpplane[prerequisites for run dumpplane] are satisfied.

Refer blow steps to run `dumpplane`.

=== Step 1: prepare nginx dump file

[source, bash]
----
$ ls pipeline/config/conf
nginx.conf_10.1.10.171	nginx.conf_10.1.10.195	nginx.conf_10.1.10.8
----

NOTE: `input` is folder, which contains 3 files, each file are output of `nginx -T`.

=== Step 2: dumpplane split

[source, bash]
----
$ dumpplane split input
----

=== Step 3: crossplane parse

[source, bash]
----
for i in $(ls ~/.dumpplane/data/) ; do crossplane parse -o ~/.dumpplane/data/$i.json ~/.dumpplane/data/$i/nginx.conf ; done
----

NOTE: The *data* is dumpplane output file path, recommended crossplane output file are same as dumpplane output file path, or else you need specify `--input` while running dumpplane dump.

NOTE: Current crossplane parse output must equals `nginx -T` plus `.json`.

=== Step 4: dumpplane dump

[source, bash]
----
dumpplane dump pipeline/config/conf -o mongodb://127.0.0.1:27017 --db nginx --table configurations
----

This step will dump both `dumpplane` parsed result and `crossplane` parsed result as a single document to MongoDB database `nginx` and collection `configurations`.

NOTE: `nginx -T` output file name used as a primary key, which means if same file be dumped many times, only the 1st time is insert, the rest are upset.

NOTE: Run `dumpplane dump` with argument `-o http://localhost:9200 --db nginx` will index all configurations to ElasticSearch.

=== Step 5: nginx management & governance

Refer to link:#nginx-management-governance[NGINX Management & Governance].

== NGINX Management & Governance

=== Total NGINX Host

[source, sql]
----
nginx> db.configurations.countDocuments()
31
----

=== NGINX Configration Files View

[source, sql]
.*SQL*
----
var pipeline = [
  {$addFields: 
    {
      status: '$crossplane.status',
      errors: '$crossplane.errors',
      config: '$crossplane.config'
    }
  }, 
  {
    $unwind: {
      path: '$config',
      includeArrayIndex: 'row',
      preserveNullAndEmptyArrays: true
    }
  }, 
  {
    $addFields: {
      fileStatus: '$config.status',
      content: '$config.parsed',
      filePath: '$config.file'
    }
  }, 
  {
    $project: {
      crossplane: 0,
      dumpplane: 0,
      config: 0
    }
  }
]
----

[source, sql]
.*Create View*
----
db.createView("configurationFiles", "configurations", pipeline)
----

=== Total NGINX Configration Files

[source, sql]
----
> db.configurationFiles.countDocuments()
154
----

=== Top 5 configuration files with the most configuration blocks

[source, sql]
.*SQL*
----
var pipeline = [
  {
    $addFields: {
      totalBlocks: {
        $size: '$content'
      }
    }
  }, 
  {
    $sort: {
      totalBlocks: -1
    }
  }, 
  {
    $limit: 5
  }, 
  {
    $project: {
      _id: 0,
      ngxHost: 1,
      filePath: 1,
      totalBlocks: 1
    }
  }
]
----

[source, sql]
.*Aggregate*
----
> db.configurationFiles.aggregate(pipeline)
[
  {
    ngxHost: '15.55.40.185',
    filePath: '/etc/nginx/conf.d/app.conf',
    totalBlocks: 11
  },
  {
    ngxHost: '104.3.42.121',
    filePath: '/etc/nginx/conf.d/app.conf',
    totalBlocks: 10
  },
  {
    ngxHost: '103.10.16.101',
    filePath: '/etc/nginx/conf.d/app.conf',
    totalBlocks: 9
  },
  {
    ngxHost: '10.1.10.195',
    filePath: '/etc/nginx/nginx.conf',
    totalBlocks: 9
  },
  {
    ngxHost: '10.1.10.171',
    filePath: '/etc/nginx/nginx.conf',
    totalBlocks: 6
  }
]
----

=== Top 5 NGINX hosts with the most number of configuration files

[source, sql]
.*SQL*
----
var pipeline = [
  {
    $group: {
      _id: '$ngxHost',
      count: {
        $count: {}
      }
    }
  }, 
  {
    $sort: {
      count: -1
    }
  },
  {
    $limit: 5
  } 
]
----

[source, sql]
.*Aggregate*
----
> db.configurationFiles.aggregate(pipeline)
[
  { _id: '10.1.10.195', count: 58 },
  { _id: '10.1.10.8', count: 8 },
  { _id: '10.1.10.171', count: 6 },
  { _id: '192.168.1.103', count: 3 },
  { _id: '10.1.10.103', count: 3 }
]
----

=== NGINX Configration Blocks View

[source, sql]
.*SQL*
----
var pipeline = [
  {
    $unwind: {
      path: '$content',
      includeArrayIndex: 'blockRow',
      preserveNullAndEmptyArrays: true
    }
  }, 
  {
    $addFields: {
      blockLineNumber: '$content.line',
      blockDirective: '$content.directive',
      blockArgs: '$content.args',
      blockIncludes: '$content.includes',
      subBlock: '$content.block'
    }
  }, 
  {$project: {
      content: 0
    }
  }
]
----

[source, sql]
.*Create View*
----
db.createView("configurationBlocks", "configurationFiles", pipeline)
----

=== Total NGINX Configration Blocks

[source, sql]
----
> db.configurationBlocks.countDocuments()
414
----

=== Total NGINX Configration http Blocks

[source, sql]
----
> db.configurationBlocks.find({ blockDirective: {$eq: "http"}}).count()
31
----

=== Total NGINX Configration stream Blocks

[source, sql]
----
> db.configurationBlocks.find({ blockDirective: {$eq: "stream"}}).count()
1
----

=== Total NGINX Configration server Blocks

[source, sql]
----
> db.configurationBlocks.find({ blockDirective: {$eq: "server"}}).count()
129
----

=== Total NGINX Configration upstream  Blocks

[source, sql]
----
> db.configurationBlocks.find({ blockDirective: {$eq: "upstream"}}).count()
53
----

=== NGINX Configration Directives View

[source, sql]
.*SQL*
----
var pipeline = [
  {
    $unwind: {
      path: '$subBlock',
      includeArrayIndex: 'directiveBlockLineNumber',
      preserveNullAndEmptyArrays: true
    }
  }, 
  {
    $addFields: {
      directiveBlockLineNumber: '$subBlock.line',
      directiveBlockDirective: '$subBlock.directive',
      directiveBlockArgs: '$subBlock.args',
      directiveBlockIncludes: '$subBlock.includes',
      directiveSubBlock: '$subBlock.block'
    }
  }, 
  {
    $project: {
      subBlock: 0
    }
  }
]
----

[source, sql]
----
db.createView("configurationDirectives", "configurationBlocks", pipeline)
----

=== Totoal NGINX Configration Directives

[source, sql]
----
> db.configurationDirectives.countDocuments()
3542
----

=== Top 5 Frequent Used Port

[source, sql]
.*SQL*
----
var pipeline = [
  {
    $match: {
      blockDirective: {
        $eq: 'server'
      },
      directiveBlockDirective: {
        $eq: 'listen'
      }
    }
  }, 
  {
    $addFields: {
      listenPort: {
        $arrayElemAt: ['$directiveBlockArgs', 0]
      }
    }
  }, 
  {
    $group: {
      _id: '$listenPort',
      count: {
        $count: {}
      }
    }
  }, 
  {
    $sort: {
      count: -1
    }
  }, 
  {
    $limit: 5
  }
]
----

[source, sql]
.*Aggregate*
----
> db.configurationDirectives.aggregate(pipeline)
[
  { _id: '8080', count: 14 },
  { _id: '9006', count: 6 },
  { _id: '9004', count: 6 },
  { _id: '9000', count: 6 },
  { _id: '9003', count: 5 }
]
----

=== NGINX go production configration validation

[source, sql]
.*1. Query all 3 host the the application go production related*
----
var pipeline = [
{
  $match: {
    $and: [
    {
      directiveBlockDirective: { $eq: 'location'}
    },
    {
      $or: [
      {
        ngxHost: {$eq: '10.55.140.71'}
      },
      {
        ngxHost: {$eq: '10.55.140.72'}
      },
      {
        ngxHost: {$eq: '10.55.140.73'}
      }
      ]
    }
    ]
  }
}, 
{
  $project: {
    _id: 0,
    ngxHost: 1,
    filePath: 1,
    blockDirective: 1,
    directiveBlockDirective: 1,
    configSize: {
      $size: '$directiveSubBlock'
    }
  }
}]
----

[source, sql]
.*2. Find the difference*
----
> db.configurationDirectives.aggregate(pipeline)
[
  {
    ngxHost: '10.55.140.72',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    directiveBlockDirective: 'location',
    configSize: 2
  },
  {
    ngxHost: '10.55.140.73',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    directiveBlockDirective: 'location',
    configSize: 1
  },
  {
    ngxHost: '10.55.140.71',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    directiveBlockDirective: 'location',
    configSize: 2
  }
]
----

NOTE : Nginx on host `10.55.140.73` has 1 config items, the other has 2 items.


[source, sql]
.*3. SQL for find the configuration difference*
----
var pipeline = [
{ 
  $match: {
    $and: [
    { 
      directiveBlockDirective: { $eq: 'location'}
    },
    { 
      $or: [
      { 
        ngxHost: {$eq: '10.55.140.71'}
      },
      { 
        ngxHost: {$eq: '10.55.140.72'}
      },
      { 
        ngxHost: {$eq: '10.55.140.73'}
      }
      ]
    }
    ]
  }
},
{
   $unwind: {
     path: '$directiveSubBlock',
     includeArrayIndex: 'locationDirectiveRow',
     preserveNullAndEmptyArrays: true
  }
},
{
  $project: {
    _id: 0,
    ngxHost: 1,
    filePath: 1,
    blockDirective: 1,
    directiveBlockDirective: 1,
    locationDirectiveRow: 1,
    locationDirective: '$directiveSubBlock.directive',
    locationDirectiveArgs: '$directiveSubBlock.args'
  }
}
]
----

[source, sql]
.*4. Find the difference*
----
> db.configurationDirectives.aggregate(pipeline)
[
  {
    ngxHost: '10.55.140.72',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    directiveBlockDirective: 'location',
    locationDirectiveRow: Long("0"),
    locationDirective: 'status_zone',
    locationDirectiveArgs: [ 'location_backend' ]
  },
  {
    ngxHost: '10.55.140.72',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    directiveBlockDirective: 'location',
    locationDirectiveRow: Long("1"),
    locationDirective: 'proxy_pass',
    locationDirectiveArgs: [ 'http://backend' ]
  },
  {
    ngxHost: '10.55.140.73',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    directiveBlockDirective: 'location',
    locationDirectiveRow: Long("0"),
    locationDirective: 'proxy_pass',
    locationDirectiveArgs: [ 'http://backend' ]
  },
  {
    ngxHost: '10.55.140.71',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    directiveBlockDirective: 'location',
    locationDirectiveRow: Long("0"),
    locationDirective: 'status_zone',
    locationDirectiveArgs: [ 'location_backend' ]
  },
  {
    ngxHost: '10.55.140.71',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    directiveBlockDirective: 'location',
    locationDirectiveRow: Long("1"),
    locationDirective: 'proxy_pass',
    locationDirectiveArgs: [ 'http://backend' ]
  }
]
----

NOTE: The `10.55.140.73` host lost the `status_zone` setting.

=== NGINX Configration locations View

[source, sql]
.*SQL*
----
var pipeline = [
  {
    $match: {
      directiveBlockDirective: {$eq: 'location' }
    }
  }, 
  {
    $unwind: {
      path: '$directiveSubBlock',
      includeArrayIndex: 'locationDirectiveRow',
      preserveNullAndEmptyArrays: true
    }
  }, 
  {
    $addFields: {
      locationDirective: '$directiveSubBlock.directive',
      locationDirectiveArgs: '$directiveSubBlock.args',
      locationDirectiveLine: '$directiveSubBlock.line'
    }
  }, 
  {
    $project: {
      directiveSubBlock: 0
    }
  }
]
----

[source, sql]
.*Create View*
----
db.createView("configurationLocations", "configurationDirectives", pipeline)
----

=== Totoal Locations

[source, sql]
----
> db.configurationLocations.countDocuments()
338
----

=== Find the Different Location Configrtaion

[source, sql]
----
> db.configurationLocations.find({$or: [{ngxHost: "15.55.140.71"}, {ngxHost: "15.55.140.72"}, {ngxHost: "15.55.140.73"}]},{_id: 0, ngxHost: 1, filePath: 1, blockDirective: 1, locationDirective: 1, locationDirectiveArgs: 1})
[
  {
    ngxHost: '15.55.140.72',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    locationDirective: 'status_zone',
    locationDirectiveArgs: [ 'location_backend' ]
  },
  {
    ngxHost: '15.55.140.72',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    locationDirective: 'proxy_pass',
    locationDirectiveArgs: [ 'http://backend' ]
  },
  {
    ngxHost: '15.55.140.73',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    locationDirective: 'proxy_pass',
    locationDirectiveArgs: [ 'http://backend' ]
  },
  {
    ngxHost: '15.55.140.71',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    locationDirective: 'status_zone',
    locationDirectiveArgs: [ 'location_backend' ]
  },
  {
    ngxHost: '15.55.140.71',
    filePath: '/etc/nginx/conf.d/app.conf',
    blockDirective: 'server',
    locationDirective: 'proxy_pass',
    locationDirectiveArgs: [ 'http://backend' ]
  }
]
----

